# Ralph Progress Log

## Codebase Patterns

- **CLI dispatch**: Custom dispatcher in `cmd/ralph/main.go`, not Cobra. Each command is a function in `internal/commands/`.
- **String helpers**: `init.go` has manual `splitLines`, `trimSpace`, `containsLine` to avoid importing `strings` package.
- **Test style**: Standard Go testing, table-driven where appropriate. Tests use `t.TempDir()` and `os.Chdir` for filesystem operations.
- **Idempotency**: Init checks `os.Stat` before writing files; re-runs skip existing files.
- **No external test deps**: Only stdlib + `gopkg.in/yaml.v3`.
- **Testable external calls**: Use package-level function variables (e.g. `invokeClaudeFn`) to mock external CLI calls in tests.
- **shell.Runner for git**: All git operations use `*shell.Runner` with `Dir` set to the target directory. Non-zero exits produce `*shell.ExitError` with Code and Stderr.
- **workspace package**: `internal/workspace/` provides data model (Workspace, WorkContext), path helpers, name validation, registry CRUD at `.ralph/state/workspaces.json`, per-workspace `workspace.json` read/write, `DetectCurrent` for cwd parsing, `ResolveWorkContext` for 4-level priority resolution (flag > env > cwd > base), and `DeriveBranch` for branch name derivation with pattern validation.
- **Config.BranchPrefix**: `RepoConfig.BranchPrefix` defaults to `"ralph/"` if not set in YAML. Used by workspace creation for branch derivation.
- **Config.WorkspacesDir()**: Returns `<repoPath>/.ralph/workspaces` for workspace directory management.
- **workspace.CreateWorkspace**: Creates full workspace structure (dir, workspace.json, git worktree at tree/, copies .ralph/.claude/patterns, registry). Cleans up git-checked-out state/workspaces/worktrees dirs from tree.
- **workspace.RemoveWorkspace**: Full cleanup (worktree, directory, registry, branch). Branch deletion is best-effort. Reads branch from registry directly if directory is missing.
- **gitops package**: Pure functions taking `(ctx, runner, ...)`. Worktree operations use a `repoRunner` with `Dir: repoPath`.
- **RebaseResult struct**: `StartRebase` and `ContinueRebase` return `RebaseResult{Success, HasConflicts}` for structured results.
- **Absolute git dir**: Use `git rev-parse --absolute-git-dir` (not `--git-dir`) when checking filesystem paths derived from git dir.
- **ContinueRebase editor skip**: Uses `git -c core.editor=true rebase --continue` to skip editor during automated continuation.
- **Tests with real git repos**: `initRepo(t, dir)` creates a real git repo in `t.TempDir()`. No git mocking.
- **Prompt templates**: Located in `internal/prompts/templates/*.md`, embedded via `//go:embed templates/*.md`. Each template has a corresponding `XxxData` struct and `RenderXxx` function in `prompts.go`. The internal `render()` function handles all template parsing/execution.
- **Prompt tests**: Use `strings.Contains` checks against rendered output. Test data should use meaningful values that appear in the rendered template.
- **Quality checks**: `just test` runs `go test -count=1 ./...`, `just vet` runs `go vet ./...`.
- **Command pattern**: All commands in `internal/commands/` follow: parse flags with `flag.NewFlagSet`, call `AddProjectConfigFlag(fs)`, load config via `ResolveConfig(*configPath)`, then business logic. Wire into `cmd/ralph/main.go` switch + usage text.
- **Worktree validation**: Use `gitops.IsWorktree(ctx, r)` to check if running in a worktree. Return clear error if not.
- **Claude interactive invocation**: Use `claude.Invoke(ctx, claude.InvokeOpts{Prompt: ..., Interactive: true})` — prompt becomes `--system-prompt`.
- **Shared workspace helpers**: `AddWorkspaceFlag(fs)` registers `--workspace` flag. `resolveWorkContextFromFlags(flag, repoPath)` encapsulates cwd+env+ResolveWorkContext into a single call. All commands use these for consistency.
- **E2e test pattern**: `test/e2e/workspace_e2e_test.go` uses `TestMain` to build the binary, `runRalph`/`runRalphWithStdin` helpers for controlled subprocess execution with clean env, `setupTestRepo` copies fixtures + inits git with bare remote. Agent evaluation via Claude CLI is conditional (`t.Skip` when not available). Reports collected as `cmdReport` structs with command, args, exitCode, stdout, stderr.
- **Error output in main.go**: Use `fmt.Fprintf(os.Stderr, ...)` not `log.Fatalf` for user-facing errors to avoid timestamps.

---

## 2026-02-02 - US-001
- Added interactive prompts to `ralph init`: git-tracking choice (1=track in git, 2=keep local) and LLM analysis opt-in (Y/n)
- `Init` signature changed from `Init(args []string) error` to `Init(args []string, in io.Reader) error` for testability
- `ensureGitignoreEntries` now accepts a `gitTrackChoice int` parameter: option 1 gitignores `.ralph/worktrees/` and `.ralph/state/`, option 2 gitignores entire `.ralph/`
- LLM opt-in prints placeholder message (actual implementation deferred to US-002)
- Files changed:
  - `internal/commands/init.go` — added `bufio`, `io` imports; added `promptGitTracking`, `promptLLMAnalysis` functions; updated `ensureGitignoreEntries` signature
  - `internal/commands/init_test.go` — new file with 7 tests covering both git-tracking options, LLM opt-in/out, idempotency, invalid input retry, default-yes behavior
  - `cmd/ralph/main.go` — updated Init call to pass `os.Stdin`
- **Learnings for future iterations:**
  - Pass `io.Reader` to command functions that need stdin for testability
  - `bufio.Scanner` works well for line-by-line interactive prompts
  - Tests use `strings.NewReader` to simulate stdin input
---

## 2026-02-02 - US-002
- Replaced LLM placeholder with actual Claude CLI invocation via `claude.Invoke` in `--print` mode
- Added `invokeClaudeFn` package-level variable for testability (tests swap it to mock Claude responses)
- Added `detectQualityChecks(dir)` — invokes Claude with a focused prompt asking for YAML list of quality check commands
- Added `parseQualityChecks(output)` — parses Claude's YAML output into `[]string`
- Added `buildConfigWithChecks(projectName, checks)` — generates ralph.yaml with detected quality checks via `yaml.Marshal`
- On Claude failure, falls back to default template and prints a warning
- Files changed:
  - `internal/commands/init.go` — added `context`, `claude` imports; added `invokeClaudeFn`, `qualityCheckPrompt`, `detectQualityChecks`, `parseQualityChecks`, `buildConfigWithChecks`; replaced LLM placeholder with real invocation logic
  - `internal/commands/init_test.go` — added `context`, `fmt`, `claude` imports; replaced placeholder test with `TestInit_LLMOptIn_InjectsDetectedChecks` and `TestInit_LLMOptIn_FallsBackOnClaudeFailure`; added `TestParseQualityChecks_*` unit tests
- **Learnings for future iterations:**
  - Package-level function variables (`var fn = realImpl`) is an effective Go pattern for mocking external calls without interfaces
  - `yaml.Marshal` on a `config.Config` struct produces clean YAML output suitable for ralph.yaml
  - Tests should save/restore package-level mock vars with `defer`
---

## 2026-02-02 - US-001 (rebase-and-done-commands)
- Added gitops helper functions for worktree detection, merge-base check, rebase, and squash merge
- Functions added to `internal/gitops/gitops.go`: IsWorktree, CurrentBranch, IsAncestor, FetchBranch, StartRebase, HasRebaseInProgress, ContinueRebase, AbortRebase, ConflictFiles, SquashMerge
- Added `RebaseResult` struct with `Success` and `HasConflicts` fields for structured rebase outcomes
- Files changed:
  - `internal/gitops/gitops.go` — added 11 new exported functions/types, added `errors` import
  - `internal/gitops/gitops_test.go` — new file with 9 test functions covering all helpers using real temporary git repos
- **Learnings for future iterations:**
  - `git rev-parse --git-dir` returns relative paths; use `--absolute-git-dir` when checking filesystem paths
  - `git -c core.editor=true rebase --continue` is needed to skip the editor prompt in automated rebase continuation
  - Rebase conflict detection: after a failed `git rebase`, check for `rebase-merge/` or `rebase-apply/` directories under the absolute git dir
  - `git merge-base --is-ancestor` exits with code 1 (not error) when not an ancestor — must check exit code specifically
  - SquashMerge creates a separate `repoRunner` with `Dir: repoPath` to operate on the main repo, not the worktree

---

## 2026-02-02 - US-002 (rebase-and-done-commands)
- Implemented `rebase_conflict.md` prompt template with sections for PRD description, stories, progress log, feature diff, base diff, conflicted files, and conflict resolution instructions
- Added `RebaseConflictData` struct and `RenderRebaseConflict()` function in `prompts.go`
- Added test `TestRenderRebaseConflict_ContainsAllSections` in `prompts_test.go`
- Files changed: `internal/prompts/prompts.go`, `internal/prompts/prompts_test.go`, `internal/prompts/templates/rebase_conflict.md`
- **Learnings for future iterations:**
  - Template uses `text/template` — case-sensitive checks in tests must match template casing exactly
  - The template instructs Claude to `git add` resolved files and `git rebase --continue`
  - Follow the same `XxxData` struct + `RenderXxx` function pattern for any new templates
  - **Rebase loop pattern**: After Claude's interactive session, check `HasRebaseInProgress` — if false, the rebase was either completed or aborted by Claude/user (no error either way). If true, call `ContinueRebase` to replay the next commit.
---

## 2026-02-02 - US-003 (rebase-and-done-commands)
- Implemented `ralph rebase [branch]` command in `internal/commands/rebase.go`
- Command validates worktree context, accepts optional branch arg (defaults to `config.Repo.DefaultBase`), fetches origin, starts rebase
- Conflict resolution loop: invokes Claude in print mode with rendered `rebase_conflict.md` prompt containing PRD, progress, feature diff, base diff, and conflict files
- After Claude exits, checks if rebase is still in progress; if yes, calls `ContinueRebase` and loops; if no, returns success
- Wired into `cmd/ralph/main.go` dispatch and usage text
- Existing tests for `formatStories` cover the helper; gitops primitives tested in `gitops_test.go`
- Fixed bug in original scaffold: "rebase not in progress" after Claude session was incorrectly treated as "aborted" — now correctly returns nil (success)
- Files changed: `internal/commands/rebase.go` (fixed loop logic), `.ralph/state/prd.json`, `.ralph/progress.txt`
- **Learnings for future iterations:**
  - The rebase command was largely pre-scaffolded — mainly needed loop logic fix
  - Claude print mode is preferred over interactive for automated conflict resolution
  - `buildConflictPrompt` gracefully degrades if PRD/progress/diffs are unavailable (uses zero values)
---

## 2026-02-02 - US-004
- Implemented `ralph done` command in `internal/commands/done.go`
- Command validates worktree context, fetches origin/<base>, checks ancestry via `IsAncestor`
- Generates commit message from PRD (description + completed story titles)
- Prompts user to edit message inline (Enter to accept, or type replacement)
- Performs squash merge via `gitops.SquashMerge` on the main repo path
- After success, prompts for worktree+branch cleanup (y/n)
- Wired into `cmd/ralph/main.go` dispatch and usage text
- Tests: `TestGenerateCommitMessage_IncludesDescriptionAndPassingStories`, `TestPromptEditMessage_AcceptsDefault`, `TestPromptEditMessage_ReplacesWithUserInput`, `TestShouldCleanup_Yes`, `TestShouldCleanup_No`
- Files changed: `internal/commands/done.go`, `internal/commands/done_test.go`, `cmd/ralph/main.go`
- **Learnings for future iterations:**
  - `promptEditMessage` and `shouldCleanup` accept `*os.File` for testability with `os.Pipe()`
  - `generateCommitMessage` only includes stories where `Passes == true`
  - The squash merge operates on `cfg.Repo.Path` (main repo), not the worktree cwd
  - The `formatStories` helper from rebase.go was reused conceptually, but `generateCommitMessage` filters to passing stories only
---

## 2026-02-03 - US-001 (improve-work-success-verification)
- Added `IntegrationTest` struct to `internal/prd/prd.go` with fields: ID, Description, Steps ([]string), Passes (bool), Failure (string), Notes (string)
- Added `IntegrationTests []IntegrationTest` field to `PRD` struct with `json:"integrationTests,omitempty"` tag for backwards compatibility
- Files changed:
  - `internal/prd/prd.go` — added IntegrationTest struct and IntegrationTests field to PRD
  - `internal/prd/prd_test.go` — added `TestIntegrationTests_Roundtrip` and `TestRead_PRDWithoutIntegrationTests_ParsesCorrectly`
- **Learnings for future iterations:**
  - Use `omitempty` JSON tag for new optional fields to ensure backwards compatibility with existing PRD files
  - Slice fields with `omitempty` will be omitted from JSON output when nil/empty, maintaining clean output for PRDs without integration tests
---

## 2026-02-03 - US-002 (improve-work-success-verification)
- Added "Proposing Integration Tests" section to `prd_new.md` prompt template
- Section instructs LLM to propose integration tests after user stories are agreed upon
- Includes structured format for tests (ID, Description, Steps) and guidelines emphasizing automated, re-runnable tests
- Instructs LLM to present proposed tests and ask user to confirm/refine them
- Files changed:
  - `internal/prompts/templates/prd_new.md` — added new section between "Discuss, refine..." and "Story writing guidelines"
- **Learnings for future iterations:**
  - This change is prompt-only, no Go code changes needed (template is already embedded via go:embed in prompts.go)
  - Existing tests pass because the template just needs to be valid text; no render function changes were required
---

## 2026-02-03 - US-003 (improve-work-success-verification)
- Updated `finishSkillContent` constant in `internal/commands/init.go` to include integration tests in PRD JSON schema
- Added `integrationTests` array to the JSON schema example with all fields: id, description, steps, passes, failure, notes
- Added "Integration Test Rules" section documenting:
  - Integration tests agreed upon during PRD discussion should be included
  - All fields (id IT-xxx, description, steps array, passes, failure, notes)
  - All integration tests start with `passes: false`
  - Purpose of `failure` and `notes` fields
- Files changed:
  - `internal/commands/init.go` — updated `finishSkillContent` constant with integrationTests array and rules section
- **Learnings for future iterations:**
  - The `/finish` skill content is stored as a constant in `init.go`, not as a template file
  - `ralph init` always rewrites `.claude/commands/finish.md` to keep it up to date
  - The `.claude/` directory is gitignored, so skill updates require running `ralph init` again
---

## 2026-02-03 - US-004 (improve-work-success-verification)
- Created `internal/prompts/templates/qa_verification.md` — comprehensive QA agent prompt for integration test verification
- Prompt covers all acceptance criteria:
  - Instructs agent to read `integrationTests` from PRD
  - Instructs agent to BUILD automated tests for each integration test spec
  - Instructs agent to ALSO verify autonomously (run app, check UI, call APIs)
  - Instructs agent to install tooling as needed (Playwright, etc.)
  - Instructs agent to update PRD with passes/failure/notes for each test
  - Instructs agent to save reusable testing approaches in `.ralph/skills/`
- Added `QAVerificationData` struct with fields: PRDPath, ProgressPath, QualityChecks
- Added `RenderQAVerification(data QAVerificationData)` function in `prompts.go`
- Added `TestRenderQAVerification_ContainsAllSections` test in `prompts_test.go`
- Files changed:
  - `internal/prompts/templates/qa_verification.md` — new file
  - `internal/prompts/prompts.go` — added QAVerificationData struct and RenderQAVerification function
  - `internal/prompts/prompts_test.go` — added test for QA verification prompt
- **Learnings for future iterations:**
  - Follow the established `XxxData` struct + `RenderXxx` function pattern for new templates
  - The `//go:embed templates/*.md` directive automatically picks up new .md files
  - Template uses `{{range .QualityChecks}}` for iterating over quality checks
---

## 2026-02-03 - US-005 (improve-work-success-verification)
- Created `internal/prompts/templates/qa_fix.md` — QA fix agent prompt for resolving integration test failures
- Prompt covers all acceptance criteria:
  - Instructs agent to read integration test failures from PRD (via `FailedTests` field in template data)
  - Instructs agent to FIRST reproduce failure with an automated test before fixing
  - Instructs agent to fix the code until the automated test passes
  - Specifies commit format: `fix(QA): <description>`
- Added `QAFixData` struct with fields: PRDPath, ProgressPath, QualityChecks, FailedTests ([]prd.IntegrationTest)
- Added `RenderQAFix(data QAFixData)` function in `prompts.go`
- Added `TestRenderQAFix_ContainsAllSections` test in `prompts_test.go`
- Files changed:
  - `internal/prompts/templates/qa_fix.md` — new file
  - `internal/prompts/prompts.go` — added QAFixData struct and RenderQAFix function
  - `internal/prompts/prompts_test.go` — added test for QA fix prompt
- **Learnings for future iterations:**
  - QAFixData uses `[]prd.IntegrationTest` directly from the prd package for FailedTests
  - Template iterates over failed tests with `{{range .FailedTests}}` and accesses fields like `.ID`, `.Description`, `.Steps`, `.Failure`, `.Notes`
  - Nested range for steps: `{{range .Steps}}- {{.}}\n{{end}}`
---

## 2026-02-04 - US-006 (improve-work-success-verification)
- Verified that render functions for QA templates were already implemented in US-004 and US-005
- All acceptance criteria already satisfied:
  - `QAVerificationData` struct exists with PRDPath, ProgressPath, QualityChecks fields
  - `RenderQAVerification(data QAVerificationData)` renders qa_verification.md template
  - `QAFixData` struct exists with PRDPath, ProgressPath, QualityChecks, FailedTests fields
  - `RenderQAFix(data QAFixData)` renders qa_fix.md template
  - Tests exist: `TestRenderQAVerification_ContainsAllSections`, `TestRenderQAFix_ContainsAllSections`
- All quality checks pass (`just test`, `just vet`)
- Files unchanged (implementation was complete)
- **Learnings for future iterations:**
  - Story dependencies: US-006 overlapped with US-004/US-005 — the render functions were implemented alongside the templates
  - This is expected when iteratively breaking down work — sometimes a later story is effectively complete from earlier work
---

## 2026-02-04 - US-007 (improve-work-success-verification)
- Added QA verification phase to the loop execution in `internal/loop/loop.go`
- Implementation details:
  - Added `invokeOpts` struct with `prompt`, `dir`, and `isQAVerification` fields for testable Claude invocations
  - Added `invokeClaudeFn` package-level variable (defaulting to `claude.Invoke`) for testability
  - Added `runQAVerification(ctx, cfg)` helper function that renders qa_verification.md and invokes Claude
  - Modified main loop to detect when all stories pass (`NextUnfinished` returns nil)
  - When stories complete and integration tests exist, loop invokes QA verification agent
  - After QA agent completes, loop re-reads PRD and checks if all integration tests pass
  - If tests don't pass, loop continues (allowing fix cycles in future US-008)
  - If no integration tests exist, loop completes immediately after stories pass
- Added comprehensive test suite in `internal/loop/loop_test.go`:
  - `TestRun_InvokesQAVerificationWhenAllStoriesPass` — verifies QA agent is invoked when stories complete
  - `TestRun_SkipsQAVerificationWhenNoIntegrationTests` — verifies no QA invocation without integration tests
  - `TestRun_QAVerificationReceivesCorrectContext` — verifies correct WorkDir and prompt context
  - `TestRun_ReturnsSuccessAfterQAVerificationCompletes` — verifies loop exits on success
  - `TestRun_ContinuesLoopIfQAVerificationDoesNotPassAllTests` — verifies retry behavior
  - `TestEnsureProgressFile_CreatesFileIfNotExists` and `TestEnsureProgressFile_DoesNotOverwriteExisting`
- Files changed:
  - `internal/loop/loop.go` — added invokeOpts, invokeClaudeFn, runQAVerification; modified Run to detect story completion and invoke QA
  - `internal/loop/loop_test.go` — new file with 7 tests covering QA verification behavior
- **Learnings for future iterations:**
  - The `invokeOpts.isQAVerification` flag allows tests to distinguish QA invocations from story invocations
  - Loop continues after QA verification if tests fail — this prepares for US-008's fix cycle
  - When no integration tests exist, loop exits immediately after stories pass (backwards compatible)
  - The same `invokeClaudeFn` pattern from `internal/commands/init.go` works well for loop testing
---

## 2026-02-04 - US-008 (improve-work-success-verification)
- Added QA fix cycle to loop execution in `internal/loop/loop.go`
- Implementation details:
  - Added `isQAFix` field to `invokeOpts` struct for testability
  - Added `runQAFix(ctx, cfg, failedTests)` helper function that renders qa_fix.md with failed tests and invokes Claude
  - Modified loop to invoke fix agent after QA verification when tests fail
  - Loop flow: QA verification → check for failures → invoke fix agent → re-verify (continues until all pass or max iterations)
- Added `FailedIntegrationTests(p *PRD)` helper to `internal/prd/prd.go`:
  - Returns slice of integration tests where `Passes == false`
  - Returns nil when no tests fail (consistent with Go slice semantics)
- Added comprehensive test suite:
  - `TestFailedIntegrationTests_ReturnsOnlyFailing` — verifies correct filtering
  - `TestFailedIntegrationTests_Empty_ReturnsNil` — verifies nil for empty PRD
  - `TestFailedIntegrationTests_AllPassing_ReturnsNil` — verifies nil when all pass
  - `TestRun_InvokesQAFixWhenIntegrationTestsFail` — verifies fix agent is invoked after verification fails
  - `TestRun_QAFixReceivesFailedTests` — verifies fix prompt contains failed test details (ID, failure message)
  - `TestRun_FixCycleContinuesUntilAllTestsPass` — verifies multiple fix iterations work
  - `TestRun_FixCycleRespectsMaxIterations` — verifies max iterations limit is enforced
- Files changed:
  - `internal/loop/loop.go` — added isQAFix flag, runQAFix function, modified loop to invoke fix cycle
  - `internal/loop/loop_test.go` — added 4 new tests for fix cycle behavior
  - `internal/prd/prd.go` — added FailedIntegrationTests function
  - `internal/prd/prd_test.go` — added 3 tests for FailedIntegrationTests
- **Learnings for future iterations:**
  - The fix cycle naturally integrates with the existing verification loop — after fix, next iteration re-verifies
  - `FailedIntegrationTests` returns nil (not empty slice) when no failures, following Go conventions
  - The `isQAFix` flag in invokeOpts allows tests to distinguish fix invocations from verification invocations
  - Fix prompt receives full IntegrationTest structs including Failure field for context
---

## 2026-02-04 - US-009 (improve-work-success-verification)
- Updated `loop_iteration.md` prompt to reflect new completion criteria requiring both stories AND integration tests to pass
- Added two new tests to `loop_test.go`:
  - `TestRun_CompleteSignalRejectedWhenIntegrationTestsFail` — verifies COMPLETE signal is rejected when integration tests fail
  - `TestRun_CompleteSignalAcceptedWhenBothStoriesAndIntegrationTestsPass` — verifies loop exits immediately when all pass
- Added `TestRenderLoopIteration_CompletionRequiresBothStoriesAndIntegrationTests` to `prompts_test.go` — verifies template mentions both userStories and integrationTests in completion criteria
- The loop.go code already had the correct implementation from US-007/US-008 — this story updates the agent prompt to match
- Files changed:
  - `internal/prompts/templates/loop_iteration.md` — updated completion check section
  - `internal/prompts/prompts_test.go` — added template test for completion criteria
  - `internal/loop/loop_test.go` — added two tests for COMPLETE signal behavior
- **Learnings for future iterations:**
  - The loop completion logic was already implemented in US-007/US-008; this story focused on the prompt documentation
  - Tests verify both the template content (prompts_test.go) and the runtime behavior (loop_test.go)
  - When testing COMPLETE signal rejection, ensure the test starts with a story that needs to be marked as passing
---

## 2026-02-04 - US-001 (worktree-copy-and-local-mode)
- Added `CopyDotClaude` function to `internal/gitops/gitops.go` to copy `.claude` directory to worktrees
- Function follows same pattern as `CopyDotRalph`: checks if directory exists, recursively copies all files
- Unlike `CopyDotRalph`, no directories are skipped (`.claude` has no ephemeral directories like worktrees/state)
- Integrated call to `CopyDotClaude` in `internal/commands/run.go` after `CopyDotRalph` call (step 6)
- Added two tests to `internal/gitops/gitops_test.go`:
  - `TestCopyDotClaude_CopiesDirectory` — verifies files and subdirectories are copied correctly
  - `TestCopyDotClaude_NoErrorWhenMissing` — verifies no error when `.claude` doesn't exist
- Files changed:
  - `internal/gitops/gitops.go` — added `CopyDotClaude` function
  - `internal/gitops/gitops_test.go` — added two tests for new function
  - `internal/commands/run.go` — added call to `CopyDotClaude` after `CopyDotRalph`
- **Learnings for future iterations:**
  - Follow existing patterns (`CopyDotRalph`) when adding similar functionality
  - The `.claude` directory is simpler than `.ralph` — no directories need to be skipped
  - Tests use `t.TempDir()` for isolated filesystem tests without needing git repos
---

## 2026-02-04 - US-002 (worktree-copy-and-local-mode)
- Added `CopyToWorktree` field to `Config` struct in `internal/config/config.go`
- Field is `[]string` with YAML tag `copy_to_worktree,omitempty` for optional backwards-compatible support
- Added three tests in `internal/config/config_test.go`:
  - `TestLoad_CopyToWorktree_ParsesField` — verifies list of glob patterns is parsed correctly
  - `TestLoad_CopyToWorktree_OptionalField` — verifies config loads when field is omitted (nil)
  - `TestLoad_CopyToWorktree_EmptyList` — verifies config loads with empty list
- Updated example config `assets/examples/ralph.wanidroid.yaml` with commented `copy_to_worktree` example
- Files changed:
  - `internal/config/config.go` — added CopyToWorktree field to Config struct
  - `internal/config/config_test.go` — added 3 tests for new field
  - `assets/examples/ralph.wanidroid.yaml` — added commented copy_to_worktree example
- **Learnings for future iterations:**
  - Use `omitempty` tag for optional slice fields to maintain backwards compatibility
  - Config field is just []string — validation/expansion of globs happens at copy time (US-003/US-004)
  - Tests verify both nil (omitted) and empty list cases for optional fields
---

## 2026-02-04 - US-003 (worktree-copy-and-local-mode)
- Added `CopyGlobPatterns` function to `internal/gitops/gitops.go` for flexible file copying
- Added `github.com/bmatcuk/doublestar/v4` dependency for `**` recursive glob support
- Function supports:
  - Single-level wildcards (`configs/*.json`)
  - Recursive wildcards (`fixtures/**/*.txt`)
  - Literal paths (`scripts/setup.sh`)
  - Directory paths (copied recursively)
- Preserves relative path structure in destination
- Patterns that match nothing invoke a warning callback but don't error
- Added helper function `copyDir` for recursive directory copying
- Added 8 comprehensive tests in `internal/gitops/gitops_test.go`:
  - `TestCopyGlobPatterns_LiteralPath` — verifies literal file paths are copied
  - `TestCopyGlobPatterns_SingleLevelWildcard` — verifies `*.json` patterns work
  - `TestCopyGlobPatterns_RecursiveWildcard` — verifies `**/*.txt` patterns work at all depths
  - `TestCopyGlobPatterns_DirectoryPath` — verifies directory paths are copied recursively
  - `TestCopyGlobPatterns_NoMatchesWarns` — verifies warning callback is invoked for no-match patterns
  - `TestCopyGlobPatterns_EmptyPatterns` — verifies empty pattern list does nothing
  - `TestCopyGlobPatterns_PreservesRelativePath` — verifies exact path structure is preserved
- Files changed:
  - `internal/gitops/gitops.go` — added `CopyGlobPatterns` and `copyDir` functions, added doublestar import
  - `internal/gitops/gitops_test.go` — added 8 tests for CopyGlobPatterns
  - `go.mod` — added `github.com/bmatcuk/doublestar/v4` dependency
  - `go.sum` — updated with new dependency
- **Learnings for future iterations:**
  - Go's standard `filepath.Glob` doesn't support `**` — use `bmatcuk/doublestar` for full glob support
  - `doublestar.Glob` takes `fs.FS` as first arg — use `os.DirFS(srcDir)` to create a filesystem rooted at source
  - Separate handling for directory paths (detected via `os.Stat`) from glob patterns
  - Warning callback pattern (`func(string)`) allows callers to handle no-match cases flexibly
---

## 2026-02-04 - US-004 (worktree-copy-and-local-mode)
- Integrated `CopyGlobPatterns` into worktree creation in `internal/commands/run.go`
- After copying `.ralph/` and `.claude/`, now calls `gitops.CopyGlobPatterns` with `cfg.CopyToWorktree` patterns
- Added step 7 between `.claude/` copy and prd.json write (renumbered step 8)
- Warning callback uses `log.Printf("[run] warning: %s", msg)` to log patterns that match nothing
- Empty pattern list (nil or `[]string{}`) is handled gracefully — no copy operation occurs
- Files changed:
  - `internal/commands/run.go` — added CopyGlobPatterns call after CopyDotClaude
- **Learnings for future iterations:**
  - Integration changes are minimal when underlying functions are well-designed (5 lines of code)
  - `CopyGlobPatterns` is already thoroughly tested in `gitops_test.go` — no new tests needed for the wiring
  - The warning callback pattern allows consistent logging without tight coupling
---

## 2026-02-04 - US-005 (worktree-copy-and-local-mode)
- Added `--local` flag to `ralph run` command in `internal/commands/run.go`
- Flag is defined with `fs.Bool("local", false, "Run loop in current directory without creating a worktree")`
- Flag defaults to `false`, preserving existing behavior
- Updated help text in `cmd/ralph/main.go` to document the `--local` flag
- Added test file `internal/commands/run_test.go` with:
  - `TestRun_LocalFlagParsing` — table-driven tests for flag parsing (default, --local, --local=true, --local=false)
  - `TestWorktreeRoot_DetectsWorktreePath` — tests for worktree detection helper function
- Files changed:
  - `internal/commands/run.go` — added `--local` flag definition
  - `cmd/ralph/main.go` — updated usage text with `--local` flag
  - `internal/commands/run_test.go` — new file with flag parsing tests
- **Learnings for future iterations:**
  - Go's `flag` package allows `--flag`, `--flag=true`, `--flag=false` syntax automatically
  - Flag definition belongs in the command, but placeholder `_ = local` keeps go vet happy until behavior is implemented (US-006)
  - Testing flag parsing separately from behavior allows incremental story completion
---

## 2026-02-04 - US-006 (worktree-copy-and-local-mode)
- Implemented `--local` flag behavior in `internal/commands/run.go`
- When `--local` is set:
  - Gets current working directory via `os.Getwd()`
  - Checks for PRD at `cwd/.ralph/state/prd.json`, errors if not found
  - Skips all worktree creation logic (branch checks, worktree creation, file copying)
  - Runs loop directly in current working directory via `runLoop(ctx, cwd, ...)`
  - Progress and PRD updates naturally write to cwd since loop.Config.WorkDir is cwd
- Added two tests in `internal/commands/run_test.go`:
  - `TestRunLocal_FailsWhenPRDDoesNotExist` — verifies error when PRD missing
  - `TestRunLocal_PRDExistenceCheck` — verifies no "PRD not found" error when PRD exists (may fail later on Claude invocation, which is expected)
- Files changed:
  - `internal/commands/run.go` — added local mode logic at the top of `Run()` function
  - `internal/commands/run_test.go` — added two new test functions
- **Learnings for future iterations:**
  - Local mode is a simple early-return pattern: check flag, validate PRD exists, run loop, return
  - Tests need complete config (including `project` field) to avoid config validation errors
  - Testing with `--max-iterations=0` allows verifying setup without invoking Claude
---

## 2026-02-04 - US-001 (workspace-management)
- Created `internal/workspace/` package with complete data model and persistence layer
- Structs: `Workspace` (Name, Branch, CreatedAt), `WorkContext` (Name, WorkDir, PRDPath)
- Path helpers: `WorkspacePath`, `TreePath`, `PRDPathForWorkspace`
- Name validation: `ValidateName` enforces `^[a-zA-Z0-9._-]+$` pattern
- Branch derivation: `DeriveBranch(prefix, name, branchPattern)` with optional regex validation
- Current detection: `DetectCurrent(cwd)` parses cwd for `.ralph/workspaces/<name>/tree` segment
- Registry CRUD at `.ralph/state/workspaces.json`: `RegistryCreate`, `RegistryList`, `RegistryGet`, `RegistryRemove`, `RegistryListWithMissing`
- Per-workspace metadata: `ReadWorkspaceJSON`, `WriteWorkspaceJSON` at `.ralph/workspaces/<name>/workspace.json`
- Work context resolution: `ResolveWorkContext(flag, env, cwd, repoPath)` with 4-level priority
- Config changes: added `BranchPrefix` field to `RepoConfig` (default: `"ralph/"`, YAML tag `branch_prefix`), added `WorkspacesDir()` method
- Files changed:
  - `internal/workspace/workspace.go` — new file with full workspace package
  - `internal/workspace/workspace_test.go` — new file with 30 tests
  - `internal/config/config.go` — added BranchPrefix field, default, WorkspacesDir method
  - `internal/config/config_test.go` — added 3 tests for BranchPrefix and WorkspacesDir
- **Learnings for future iterations:**
  - `strings.Cut` preferred over `strings.Index` (stringscut lint rule)
  - Registry uses `[]registryEntry` not map — preserves insertion order and is simpler for small lists
  - `RegistryListWithMissing` returns raw entries with Missing flag; `RegistryList` returns clean `[]Workspace`
  - `ResolveWorkContext` does NOT verify workspace existence — callers handle that when needed
  - Config defaults (like BranchPrefix) are set in `Load()` after unmarshal, before validate
---

## 2026-02-04 - US-002 (workspace-management)
- Implemented `CreateWorkspace` and `RemoveWorkspace` functions in `internal/workspace/gitops.go`
- `CreateWorkspace(ctx, runner, repoPath, ws, base, copyPatterns)` creates full workspace structure:
  - Creates `.ralph/workspaces/<name>/` directory and writes `workspace.json`
  - Creates git worktree at `.ralph/workspaces/<name>/tree/` (handles existing branch resume scenario)
  - Removes `.ralph/state/`, `.ralph/workspaces/`, `.ralph/worktrees/` from tree if checked out by git
  - Copies `.ralph/` (skipping worktrees/, state/, workspaces/), `.claude/` if exists, and copy_to_worktree patterns
  - Updates workspace registry
- `RemoveWorkspace(ctx, runner, repoPath, name)` performs full cleanup:
  - Removes git worktree, deletes workspace directory recursively, removes registry entry, deletes git branch
  - Handles missing directory gracefully (reads branch from registry directly)
- Updated `CopyDotRalph` in `internal/gitops/gitops.go` to skip `workspaces/` directory (in addition to `worktrees/` and `state/`)
- Files changed:
  - `internal/workspace/gitops.go` — new file with `CreateWorkspace` and `RemoveWorkspace` functions
  - `internal/workspace/gitops_test.go` — new file with 6 tests covering all scenarios
  - `internal/gitops/gitops.go` — added `workspaces` to `skipDirs` in `CopyDotRalph`
- **Learnings for future iterations:**
  - When git worktree checks out committed files (e.g., `.ralph/state/`), they need to be explicitly removed after worktree creation — `CopyDotRalph` skip logic only prevents copying, not removes existing checkout
  - `CreateWorkspace` falls back to local base if `origin/<base>` doesn't exist (supports local-only repos without remotes)
  - `RemoveWorkspace` reads branch from registry entries directly when `RegistryGet` fails (e.g., missing directory), avoiding chicken-and-egg problem
  - Branch deletion in `RemoveWorkspace` is best-effort (may already be gone or checked out elsewhere)
  - Tests use `realPath(t, t.TempDir())` via `filepath.EvalSymlinks` to handle macOS `/private/var/...` symlinks for temp dirs
---

## 2026-02-04 - US-003 (workspace-management)
- Implemented `ralph shell-init` command that outputs a shell function wrapping the ralph binary
- Shell function intercepts workspace commands (workspaces new/switch/remove, switch, done) to handle `cd` and `RALPH_WORKSPACE` env var natively
- Detects shell from `$SHELL` env var via `filepath.Base`; supports bash and zsh (any path)
- Unsupported shells produce descriptive error with detected shell path
- Shell function uses `command ralph` to prevent recursion, captures stdout for path, lets stderr pass through
- Sets `RALPH_SHELL_INIT=1` on function definition for detection by other commands
- `workspaces new` handler checks for `../prd.json` (workspace-level) and chains `command ralph prd new` if missing
- `workspaces switch` handles `base` specially (unset RALPH_WORKSPACE) vs named workspace (export)
- `workspaces remove` and `done` cd to stdout path and unset RALPH_WORKSPACE when applicable
- Files changed:
  - `internal/commands/shell_init.go` — new file with `ShellInit`, `shellInit`, `shellFunction` functions
  - `internal/commands/shell_init_test.go` — new file with 8 tests: function declaration checks, env exports, case statements, syntax validation (bash -n, zsh -n), various shell paths, stdout capture pattern
  - `cmd/ralph/main.go` — added `shell-init` case in dispatch and usage text
- **Learnings for future iterations:**
  - `filepath.Base(shellPath)` extracts shell name from any path (e.g., `/usr/local/bin/zsh` → `zsh`)
  - Same shell function works for both bash and zsh — POSIX-compatible case/esac with `$()` substitution
  - `bash -n` and `zsh -n` provide reliable syntax validation in tests via `exec.Command`
  - Shell function uses `__output` and `__exit` prefixed with `__` to avoid polluting user's namespace
  - The `shellInit` helper accepting `io.Writer` makes the function easily testable without environment dependency
---

## 2026-02-04 - US-004 (workspace-management)
- Implemented `ralph workspaces` command with sub-routing in `internal/commands/workspaces.go`
- Sub-routing dispatches: new, list, switch, remove; no subcommand defaults to list
- `workspacesNew` implementation:
  - Validates workspace name via `workspace.ValidateName`
  - Checks `RALPH_SHELL_INIT` env var with descriptive error + eval command
  - Checks for duplicate workspace via `workspace.RegistryGet`; error message suggests `ralph workspaces switch`
  - Derives branch via `workspace.DeriveBranch` with config prefix/pattern
  - Checks if branch exists locally via `gitops.BranchExistsLocally`; prompts fresh/resume
  - Fresh: deletes existing branch, lets `CreateWorkspace` create new one
  - Resume: lets `CreateWorkspace` detect existing branch and use it
  - Calls `workspace.CreateWorkspace` with full config (base, copy patterns)
  - stderr: `✓ Created workspace '<name>' (branch: <branch>)`
  - stdout: absolute path to `tree/` directory for shell function cd
- List, switch, remove are stubbed with "not yet implemented" errors (US-005, US-006)
- Registered `workspaces` command in `cmd/ralph/main.go` dispatch and usage text
- Comprehensive tests in `internal/commands/workspaces_test.go`:
  - `TestWorkspacesNew_SuccessfulCreation` — verifies stdout path, registry entry, directory structure, workspace.json
  - `TestWorkspacesNew_DuplicateNameError` — verifies "already exists" error with switch suggestion
  - `TestWorkspacesNew_InvalidNameError` — table-driven: empty name, spaces, slashes
  - `TestWorkspacesNew_MissingShellInitError` — verifies shell-init error message + eval command
  - `TestWorkspacesNew_ExistingBranch_Resume` — verifies resume with existing commit preserved
  - `TestWorkspacesNew_ExistingBranch_Fresh` — verifies fresh start without old files
  - `TestWorkspaces_SubRouting` — verifies all sub-routing paths (default to list, explicit list, switch, remove, unknown)
  - `TestPromptBranchChoice_ValidChoices` — table-driven: fresh, resume
  - `TestPromptBranchChoice_InvalidChoice` — verifies error for invalid input
- Files changed:
  - `internal/commands/workspaces.go` — new file with Workspaces dispatch, workspacesNew, promptBranchChoice, stubs
  - `internal/commands/workspaces_test.go` — new file with 9 test functions
  - `cmd/ralph/main.go` — added workspaces case in dispatch and usage text
- **Learnings for future iterations:**
  - `workspacesDispatch` accepts `io.Reader` for testable stdin (branch choice prompt)
  - `captureStdout` test helper uses `os.Pipe()` to capture stdout from functions that use `fmt.Println`
  - The `RegistryGet` function returns an error for both "not found" and "missing directory" — use the err==nil check to detect "already exists"
  - Tests use `initTestRepo` helper that creates repo with `main` branch and `.ralph/ralph.yaml` config
  - Config discovery via `os.Chdir` in tests requires save/restore of original dir
  - `realPath` via `filepath.EvalSymlinks` needed for macOS `/private/var/...` temp dir symlinks
---

## 2026-02-05 - US-005 (workspace-management)
- Implemented `ralph workspaces list` and `ralph workspaces switch` commands
- `workspacesList` implementation:
  - Accepts `--project-config` flag
  - Reads registry via `RegistryListWithMissing`, resolves current workspace via `ResolveWorkContext`
  - Always shows `base` first, marks current workspace with `*` prefix and `[current]` tag
  - Shows `[missing]` for workspaces whose directories no longer exist
  - When no workspaces registered, shows hint: `Create a workspace: ralph workspaces new <name>`
- `workspacesSwitch` implementation:
  - Accepts `--project-config` flag and workspace name as positional arg
  - Checks `RALPH_SHELL_INIT` env var with descriptive error + eval command
  - Special handling for `base`: outputs repo root path
  - Validates workspace exists via `RegistryGet`; maps error types to user-friendly messages
  - Not found: `Workspace "<name>" not found. Run ralph workspaces list to see available.`
  - Missing directory: `Workspace "<name>" directory is missing. Remove it: ralph workspaces remove <name>`
  - stdout: absolute path (tree/ or repo root) for shell function to cd into
  - stderr: `Switched to workspace <name>`
- Exported `WorkspaceEntry` struct from workspace package (replaces unexported `registryEntry` in `RegistryListWithMissing` return type)
- Updated sub-routing tests: removed stale "not yet implemented" entries for list and switch
- Tests added: `TestWorkspacesList_EmptyRegistry`, `TestWorkspacesList_WithWorkspaces`, `TestWorkspacesList_CurrentMarked`, `TestWorkspacesList_MissingDir`, `TestWorkspacesSwitch_OutputsCorrectPath`, `TestWorkspacesSwitch_ToBase`, `TestWorkspacesSwitch_Nonexistent`, `TestWorkspacesSwitch_MissingDirectory`, `TestWorkspacesSwitch_MissingShellInit`
- Files changed:
  - `internal/commands/workspaces.go` — replaced list/switch stubs with full implementations, added `strings` import
  - `internal/commands/workspaces_test.go` — added 9 new test functions, updated sub-routing tests
  - `internal/workspace/workspace.go` — added exported `WorkspaceEntry` struct, updated `RegistryListWithMissing` return type
- **Learnings for future iterations:**
  - `RegistryListWithMissing` originally returned unexported `registryEntry` — needed to export as `WorkspaceEntry` for cross-package use
  - `RegistryGet` returns different error messages for "not found" vs "directory is missing" — use `strings.Contains` to dispatch appropriate user-facing errors
  - Switch to `base` is handled as a special case before registry lookup (base is not in registry)
  - List output is human-facing stdout (not intercepted by shell function); switch stdout is machine output (captured by shell function for cd)
  - `ResolveWorkContext` with empty flag/env and repo root cwd returns "base" — used to detect current context for list marking
---

## 2026-02-05 - US-006 (workspace-management)
- Implemented `ralph workspaces remove <name>` command in `internal/commands/workspaces.go`
  - Accepts `--project-config` flag
  - Validates workspace exists in registry via `RegistryListWithMissing` (handles both existing and missing-dir cases)
  - Calls `workspace.RemoveWorkspace` for full cleanup (worktree, directory, registry, branch)
  - Detects if removing current workspace via `ResolveWorkContext` (env/cwd detection)
  - If removing current: stdout outputs base repo path for shell function cd + RALPH_WORKSPACE unset
  - If removing non-current: no stdout
  - stderr: `✓ Removed workspace '<name>'`
- Replaced `ralph switch` (old worktree-based subshell spawner) with interactive workspace picker
  - Uses `huh.NewSelect` with `huh.NewForm().WithOutput(os.Stderr)` so stdout is free for path
  - Reads registry via `RegistryListWithMissing`, includes `base` as first option, skips missing workspaces
  - Checks `RALPH_SHELL_INIT` env var; error if not set
  - stdout: selected workspace tree/ path (or repo root for base)
  - Cancelled selection: non-zero exit code, no stdout
  - `switchPickerFn` package-level variable for testability (mock picker in tests)
- Updated `cmd/ralph/main.go` usage text for switch command
- Tests added:
  - `TestWorkspacesRemove_VerifyCleanup` — creates workspace, removes it, verifies directory and registry cleaned
  - `TestWorkspacesRemove_CurrentWorkspace_OutputsBasePath` — sets RALPH_WORKSPACE, removes, verifies stdout has repo root
  - `TestWorkspacesRemove_Nonexistent_Error` — verifies "not found" error for nonexistent workspace
  - `TestSwitch_MissingShellInit` — verifies shell integration required error
  - `TestSwitch_SelectsWorkspace_OutputsTreePath` — mocked picker returns workspace, verifies stdout path
  - `TestSwitch_SelectsBase_OutputsRepoRoot` — mocked picker returns base, verifies stdout is repo root
  - `TestSwitch_CancelledSelection_Error` — mocked picker cancels, verifies non-zero exit
- Updated sub-routing test: removed stale "not yet implemented" entry for remove
- Files changed:
  - `internal/commands/workspaces.go` — replaced remove stub with full implementation
  - `internal/commands/workspaces_test.go` — added 3 remove tests, updated sub-routing test
  - `internal/commands/switch.go` — replaced entirely with interactive workspace picker
  - `internal/commands/switch_test.go` — new file with 4 tests for interactive switch
  - `cmd/ralph/main.go` — updated usage text
- **Learnings for future iterations:**
  - `switchPickerFn` package-level variable pattern (same as `invokeClaudeFn`) works well for mocking `huh` interactive pickers
  - `huh.NewForm(huh.NewGroup(sel)).WithOutput(os.Stderr)` renders the TUI to stderr, keeping stdout clean for machine output
  - For remove: use `RegistryListWithMissing` (not `RegistryGet`) to validate existence — this handles both existing and missing-dir workspaces uniformly
  - Current workspace detection before removal uses `ResolveWorkContext` with env/cwd — the shell function handles unsetting RALPH_WORKSPACE after cd
  - Old switch.go used `worktreeRoot` + `shell.RunInteractive` to spawn subshells — new switch just outputs a path for the shell function wrapper
---

## 2026-02-05 - US-007 (workspace-management)
- Implemented `ralph status` command in `internal/commands/status.go`
- Full output mode with lipgloss styling:
  - Shows workspace name and branch (from registry for workspaces, from git for base)
  - If PRD exists: shows `Stories: N/M passing` and `Tests: X/Y passing` (integration tests)
  - If no PRD: shows `No PRD`
  - In base: includes hint `Tip: ralph workspaces new <name>`
  - Pass/fail coloring: green for all passing, red otherwise
- Short output mode (`--short`): single line, no colors
  - Base: `base`
  - Workspace with PRD: `<name> N/M` (e.g., `login-page 3/5`)
  - Workspace without PRD: `<name> (no prd)`
  - Suitable for `PS1="$(ralph status --short 2>/dev/null) $ "`
- Accepts `--project-config` and `--short` flags
- Registered in `cmd/ralph/main.go` dispatch and usage text
- Tests: `TestStatus_InBase`, `TestStatus_InWorkspaceWithPRD`, `TestStatus_Short_InBase`, `TestStatus_Short_InWorkspaceWithPRD`, `TestStatus_Short_WorkspaceWithoutPRD`, `TestStatus_WorkspaceWithoutPRD`, `TestStatus_IntegrationTestProgress`
- Helper `containsText` with `stripANSI` for testing lipgloss-styled output
- Files changed:
  - `internal/commands/status.go` — new file with Status command implementation
  - `internal/commands/status_test.go` — new file with 7 tests
  - `cmd/ralph/main.go` — added status case in dispatch and usage text
- **Learnings for future iterations:**
  - Lipgloss output embeds ANSI escape codes — tests need `stripANSI` helper to check text content
  - `statusRun(args, w io.Writer)` pattern allows directing output to a buffer for testing
  - `workspace.RegistryGet` returns branch info for workspace context; for base, use `gitops.CurrentBranch`
  - Short mode returns no newline — suitable for shell prompt embedding
---

## 2026-02-05 - US-008 (workspace-management)
- Refactored `ralph run` to use workspace context instead of worktree creation
- Removed ALL worktree creation logic: CreateWorktree, CopyDotRalph, CopyDotClaude, CopyGlobPatterns, PRD copy into worktree
- Removed `--local` flag entirely
- Removed `worktreeRoot()` helper function
- Added `--workspace <name>` flag
- New behavior uses `workspace.ResolveWorkContext`: workspace mode sets workDir to tree/ and prdPath to workspace-level prd.json; base mode sets workDir to cwd and prdPath to .ralph/state/prd.json with warning to stderr
- Removed BranchName validation from PRD (branch is workspace concern not PRD concern)
- Added `PRDPath` field to `LoopIterationData` struct in prompts package
- Updated `RenderLoopIteration` signature to accept prdPath parameter
- Updated `loop_iteration.md` template: explicitly tells Claude the PRD location via `{{.PRDPath}}` and instructs to read/update at that absolute path
- Updated `loop.go` to pass `cfg.PRDPath` when rendering prompt
- Removed worktree check from `chat.go` (was already broken for workspace model)
- Updated `cmd/ralph/main.go` usage text: replaced `--local` with `--workspace`
- Files changed:
  - `internal/commands/run.go` — complete rewrite: removed worktree logic, added --workspace flag, uses ResolveWorkContext
  - `internal/commands/run_test.go` — replaced old tests with new: workspace flag parsing, workspace workDir/prdPath resolution, base warning, missing PRD error, --workspace flag integration, workspace missing PRD
  - `internal/commands/chat.go` — removed worktreeRoot check (incompatible with workspace model)
  - `internal/prompts/prompts.go` — added PRDPath to LoopIterationData, updated RenderLoopIteration signature
  - `internal/prompts/prompts_test.go` — updated callers with new prdPath arg
  - `internal/prompts/templates/loop_iteration.md` — added PRD Location section, replaced hardcoded paths with {{.PRDPath}}
  - `internal/loop/loop.go` — updated RenderLoopIteration call with cfg.PRDPath
  - `cmd/ralph/main.go` — updated usage text
- **Learnings for future iterations:**
  - `ResolveWorkContext` handles all 4 priority levels (flag > env > cwd > base) — commands just call it and use the result
  - The `runLoop` helper now accepts separate `workDir` and `prdPath` params since they're different for workspace mode (prdPath is outside tree/)
  - `gitops.CurrentBranch` takes `*shell.Runner`, not a string path — need to create runner first
  - Removing `worktreeRoot()` required also fixing `chat.go` which depended on it — the worktree check was already broken for the workspace model anyway
  - Progress path comes from `cfg.Repo.Path` (repo root), not from the workspace, since progress is shared
---

## 2026-02-05 - US-009 (workspace-management)
- Refactored `ralph done` to support workspace-aware auto-cleanup and updated PRD creation flow
- `done.go` changes:
  - Added `--workspace <name>` flag
  - Uses `workspace.ResolveWorkContext` to detect workspace vs base mode
  - Workspace mode: after squash-merge, archives PRD from `WorkContext.PRDPath` to `.ralph/state/archive/`, then auto-removes workspace via `workspace.RemoveWorkspace`, stdout outputs base repo path, stderr shows merge confirmation
  - Base mode: unchanged behavior (squash-merge + optional cleanup prompt via `shouldCleanup`)
  - Added `archivePRDFromPath(sourcePath, cfg)` function for archiving from any PRD location
  - `generateCommitMessage` now accepts `prdPath string` instead of `*config.Config`
  - Added `doneNowFn` package-level var for testable time in archive paths
- `prompts.go` changes:
  - Added `PRDPath` and `WorkspaceBranch` fields to `PRDNewData` struct
  - `RenderPRDNew` now accepts `PRDNewData` struct instead of string
- `prd_new.md` changes:
  - Template now includes `Write the PRD JSON to {{.PRDPath}}`
  - Conditionally includes `Use branch name {{.WorkspaceBranch}}` when in workspace
- `prd.go` changes:
  - Added `--workspace <name>` flag
  - Uses `workspace.ResolveWorkContext` to resolve PRDPath and WorkDir
  - Looks up branch from registry when in workspace to populate `WorkspaceBranch`
  - Passes `PRDNewData` struct to `RenderPRDNew`
- `init.go` changes:
  - Updated `finishSkillContent`: replaced hardcoded `.ralph/state/prd.json` with dynamic instruction
- `main.go` usage text updated for `ralph done` and `ralph prd new` with `--workspace` flag
- Files changed:
  - `internal/commands/done.go` — refactored with workspace support, added archivePRDFromPath
  - `internal/commands/done_test.go` — updated tests, added archive and workspace-path tests
  - `internal/commands/prd.go` — added workspace resolution and PRDNewData struct usage
  - `internal/prompts/prompts.go` — updated PRDNewData struct and RenderPRDNew signature
  - `internal/prompts/prompts_test.go` — updated and added tests for new PRDNewData fields
  - `internal/prompts/templates/prd_new.md` — added PRDPath and WorkspaceBranch template fields
  - `internal/commands/init.go` — updated finishSkillContent constant
  - `cmd/ralph/main.go` — updated usage text
- **Learnings for future iterations:**
  - `archivePRDFromPath` is separate from `archiveStagedPRD` (in common.go) since it archives from any path, not just the staged PRD
  - `doneNowFn` package-level var pattern (like `invokeClaudeFn`) enables deterministic archive directory names in tests
  - `generateCommitMessage` taking a path string is more flexible than taking config — works for both workspace and base PRD locations
  - Template conditional `{{- if .WorkspaceBranch}}` with dash trims whitespace to avoid blank lines when field is empty
  - `workspace.RegistryGet` provides branch info for workspace context; branch lookup failure is non-fatal for PRD creation
---

## 2026-02-05 - US-010
- Added `--workspace <name>` flag to `ralph chat` and `ralph rebase` commands
- Created shared `resolveWorkContextFromFlags` helper in `common.go` and `AddWorkspaceFlag` for consistent flag registration
- Refactored all workspace-using commands (`run`, `done`, `prd`, `chat`, `rebase`) to use the shared helpers
- `chat.go` changes:
  - Added `--workspace` flag via `AddWorkspaceFlag(fs)`
  - Removed hardcoded `cfg.Repo.Path` for context reading; now uses `wc.WorkDir` from `ResolveWorkContext`
  - Added PRD context loading: reads PRD from `wc.PRDPath` and includes it in chat system prompt via new `PRDContext` field
  - Added `formatPRDContext` helper that formats PRD as project/description/stories summary
  - Works from base without error (no IsWorktree check)
- `rebase.go` changes:
  - Added `--workspace` flag via `AddWorkspaceFlag(fs)`
  - Replaced `gitops.IsWorktree` check with `resolveWorkContextFromFlags`
  - Base without `--workspace` returns clear error: `Rebase requires workspace context. Use --workspace <name> or switch to a workspace.`
  - Reads PRD for conflict resolution from `wc.PRDPath`
  - `shell.Runner` uses `wc.WorkDir` for all git operations
  - `resolveConflicts` and `buildConflictPrompt` now accept `workspace.WorkContext` instead of using `cfg.StatePRDPath()`
- `prompts.go` changes:
  - Added `PRDContext` field to `ChatSystemData` struct
- `chat_system.md` template updated with conditional `{{if .PRDContext}}` section
- `main.go` usage text updated with `--workspace` flag for chat and rebase
- Fixed integration_test.go: removed references to removed `--local` flag
- Files changed:
  - `internal/commands/common.go` — added `AddWorkspaceFlag`, `resolveWorkContextFromFlags`, workspace import
  - `internal/commands/chat.go` — refactored to use workspace context and PRD loading
  - `internal/commands/chat_test.go` — added 4 new tests: workspace flag parsing, base context resolution, workspace context with PRD, PRD context formatting
  - `internal/commands/rebase.go` — refactored to use workspace context, removed IsWorktree check
  - `internal/commands/rebase_test.go` — added 3 new tests: base error without workspace, workspace context resolution, PRD from workspace path
  - `internal/commands/run.go` — refactored to use `AddWorkspaceFlag` and `resolveWorkContextFromFlags`
  - `internal/commands/done.go` — refactored to use `AddWorkspaceFlag` and `resolveWorkContextFromFlags`
  - `internal/commands/prd.go` — refactored to use `AddWorkspaceFlag` and `resolveWorkContextFromFlags`, removed `os` import
  - `internal/prompts/prompts.go` — added `PRDContext` field to `ChatSystemData`
  - `internal/prompts/prompts_test.go` — added 2 tests for PRD context in chat template
  - `internal/prompts/templates/chat_system.md` — added PRD Context section
  - `internal/commands/integration_test.go` — removed `--local` flag references
  - `cmd/ralph/main.go` — updated usage text
- **Learnings for future iterations:**
  - Shared helper `resolveWorkContextFromFlags` encapsulates `os.Getwd()` + `os.Getenv("RALPH_WORKSPACE")` + `workspace.ResolveWorkContext` into a single call — all commands now use it consistently
  - `AddWorkspaceFlag` centralizes the `--workspace` flag definition for consistency across commands
  - When refactoring internal function signatures (like `resolveConflicts`, `buildConflictPrompt`), pass `workspace.WorkContext` instead of individual paths for cleaner API
  - PRD context in chat prompt is optional (gracefully degrades when PRD doesn't exist)
  - `formatPRDContext` reuses `formatStories` from rebase.go since both are in the same package
---

## 2026-02-05 - US-011 (workspace-management)
- Added `printWorkspaceHeader(wc WorkContext, repoPath string)` helper in `internal/commands/common.go`
  - Styled with lipgloss (color "8" muted), prints to stderr
  - Format: `[workspace: <name> | <branch>]` for workspaces, `[workspace: base]` for base
  - Looks up branch from registry via `workspace.RegistryGet`
- Added `CheckLegacyWorktrees()` (exported) and `checkLegacyWorktreesInDir(repoPath)` (internal, testable) in common.go
  - Prints warning to stderr when `.ralph/worktrees/` directory exists
  - Called in `main.go` for all commands except init, shell-init, help
- Added workspace header to all commands: run, chat, rebase, done, prd, status (full mode only), validate, workspaces (list, new, switch, remove), switch
  - Excluded from: shell-init, status --short, init
- Updated `ralph init` in `init.go`:
  - Creates `.ralph/workspaces/` directory
  - Initializes `.ralph/state/workspaces.json` with `[]`
  - Changed gitignore entry from `.ralph/worktrees/` to `.ralph/workspaces/`
  - Added shell-init instructions and getting started hint to output
- Removed legacy code from `internal/gitops/gitops.go`:
  - Removed `WorktreePath` function
  - Removed `CreateWorktree` function
  - Removed `sanitizeBranch` helper (became unused)
- Updated `.gitignore`: changed `.ralph/worktrees/` to `.ralph/workspaces/`
- Rewrote `README.md` documenting workspace concept, all CLI commands, workflow, shell integration, config, PRD format, architecture
- Updated `cmd/ralph/main.go` usage text with all commands and flags
- Tests:
  - Created `internal/commands/common_test.go` with 4 tests: header for base, header for workspace, legacy warning when present, silent when absent
  - Updated `internal/commands/init_test.go`: renamed worktrees→workspaces references, added `TestInit_CreatesWorkspaceInfrastructure`
- Files changed:
  - `internal/commands/common.go` — added lipgloss import, headerStyle, printWorkspaceHeader, CheckLegacyWorktrees, checkLegacyWorktreesInDir
  - `internal/commands/common_test.go` — new file with 4 tests
  - `internal/commands/init.go` — workspaces dir, workspaces.json, gitignore, output updates
  - `internal/commands/init_test.go` — renamed test, added workspace infrastructure test
  - `internal/commands/run.go`, `chat.go`, `rebase.go`, `done.go`, `prd.go`, `status.go`, `validate.go`, `switch.go`, `workspaces.go` — added printWorkspaceHeader calls
  - `internal/gitops/gitops.go` — removed WorktreePath, CreateWorktree, sanitizeBranch
  - `cmd/ralph/main.go` — added CheckLegacyWorktrees call, updated usage text
  - `.gitignore` — .ralph/worktrees/ → .ralph/workspaces/
  - `README.md` — complete rewrite
- **Learnings for future iterations:**
  - `RegistryGet` checks workspace directory existence — tests creating registry entries must also create the workspace directory
  - `checkLegacyWorktreesInDir(repoPath)` is the internal testable version; `CheckLegacyWorktrees()` is the exported version that resolves config
  - Lipgloss color "8" provides a muted gray suitable for context headers that don't distract from main output
---

## 2026-02-05 - US-012
- Implemented comprehensive end-to-end integration test for the full workspace system
- Created test fixture at `test/fixtures/sample-project/` with realistic Go project files (main.go, main_test.go, go.mod, Justfile, .ralph/ralph.yaml)
- Created `test/e2e/workspace_e2e_test.go` with TestMain that builds the ralph binary, and 8 test functions covering:
  - `TestE2E_Init`: ralph init verification (workspaces/, workspaces.json created)
  - `TestE2E_ShellInit`: shell function syntax validation via bash -n and zsh -n
  - `TestE2E_WorkspaceLifecycle`: full lifecycle (new, list, switch, remove) with all verifications
  - `TestE2E_Status`: status in workspace context with PRD and --short format
  - `TestE2E_ErrorCases`: duplicate name, invalid name, switch/remove nonexistent
  - `TestE2E_MissingDirectory`: [missing] marker detection after manual directory removal
  - `TestE2E_ShellInitDetection`: RALPH_SHELL_INIT error when not set
  - `TestE2E_AgentEvaluation`: feeds structured report to Claude for UX scoring (Clarity, Consistency, Discoverability, Edge case handling, Completeness >= 4/5)
- Fixed `cmd/ralph/main.go`: replaced `log.Fatalf` with `fmt.Fprintf` for cleaner error output (no timestamps), improving UX consistency
- Files changed:
  - `test/fixtures/sample-project/` — new fixture directory with main.go, main_test.go, go.mod, Justfile, .ralph/ralph.yaml
  - `test/e2e/workspace_e2e_test.go` — new e2e test file (704 lines)
  - `cmd/ralph/main.go` — replaced log.Fatalf with fmt.Fprintf for error output
  - `.ralph/state/prd.json` — marked US-012 passes: true
- **Learnings for future iterations:**
  - E2e tests using exec.Command need controlled environments — use clean baseEnv with only essential vars (PATH, HOME, USER, git config) to avoid inheriting RALPH_SHELL_INIT or RALPH_WORKSPACE from the test runner
  - `ralph init` requires stdin for interactive prompts (git tracking choice, LLM analysis opt-in) — pipe "1\nn\n" for non-interactive testing
  - macOS temp dirs go through /private/var symlinks — use filepath.EvalSymlinks (realPath helper) for path comparisons
  - Agent evaluation via Claude is non-deterministic — ratings can vary between runs, but consistently >= 4/5 after fixing timestamp formatting in error messages
  - The `log.Fatalf` in main.go was causing timestamp-prefixed error messages which Claude's UX eval flagged as inconsistent with the rest of the stderr output
---
