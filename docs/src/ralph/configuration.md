# Configuration

Ralph is configured per-project via `.ralph/ralph.yaml`. It is created by `ralph init` and can be edited at any time.

## Config Discovery

When `--project-config` is not provided, Ralph walks up from the current working directory looking for `.ralph/ralph.yaml`. This means you can run commands from any subdirectory (or from inside a workspace tree).

## ralph.yaml Reference

```yaml
# Human-readable project name (required)
project: MyProject

repo:
  # Base branch for merges (required)
  default_base: main

  # Prefix prepended to workspace names to form branch names
  # e.g., "ralph/" + "login-page" = "ralph/login-page"
  branch_prefix: "ralph/"       # default: "ralph/"

  # Regex that generated branch names must match (optional)
  branch_pattern: "^ralph/[a-zA-Z0-9._-]+$"

# Directory paths relative to repo root
paths:
  tasks_dir: ".ralph/tasks"
  skills_dir: ".ralph/skills"

# Commands that must pass before the agent commits
# Each runs via sh -c in the workspace working directory
quality_checks:
  - "npm test"
  - "npm run lint"
  - "npm run typecheck"

# Files/patterns to copy from repo root into workspace worktrees (optional)
# Supports literal paths, wildcards (*), and recursive globs (**)
copy_to_worktree:
  - ".env"
  - "scripts/**"
  - "fixtures/*.json"
```

### Required Fields

| Field | Description |
|-------|-------------|
| `project` | Project name |
| `repo.default_base` | Base branch (e.g., `main`, `develop`) |

All other fields are optional with sensible defaults.

### quality_checks

Commands that must pass before the agent commits. Each command runs via `sh -c` in the workspace working directory. The agent will not commit if any check fails.

Examples:

```yaml
quality_checks:
  - "npm test"
  - "npm run lint"
  - "go test ./..."
  - "cargo clippy"
```

### copy_to_worktree

When creating a workspace, Ralph already copies `.ralph/` and `.claude/` automatically. Use `copy_to_worktree` for additional files the agent might need that aren't committed to git (e.g., `.env` files) or that live outside those directories.

Supports:
- Literal paths: `scripts/setup.sh`
- Single-level wildcards: `configs/*.json`
- Recursive globs: `fixtures/**/*.txt`
- Directories: `data/` (copied recursively)

## PRD Format

The PRD (Product Requirements Document) is a JSON file that drives the execution loop. It is generated by typing `/finish` during the PRD creation session (launched by `ralph new`) and updated by the agent during `ralph run`.

```json
{
  "project": "MyProject",
  "branchName": "ralph/login-page",
  "description": "Add user login with email and password",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add user schema and migration",
      "description": "Create the users table with email, password_hash, created_at",
      "acceptanceCriteria": [
        "Migration creates users table with correct columns",
        "Model validates email format",
        "All quality checks pass"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    }
  ],
  "integrationTests": [
    {
      "id": "IT-001",
      "description": "Full login flow works end-to-end",
      "steps": [
        "Create a user via the API",
        "POST /api/login with valid credentials",
        "Verify response contains a valid session token"
      ],
      "passes": false,
      "failure": "",
      "notes": ""
    }
  ]
}
```

### User Stories

Each story represents one iteration of the loop — it should be completable in a single Claude context window. Stories are executed in `priority` order (lowest first).

**Right-sized stories:**

- Add a database table and migration
- Add an API endpoint with tests
- Add a UI component to an existing page
- Update validation logic

**Too large (split into multiple):**

- Build the entire authentication system
- Redesign the settings page

Stories are ordered by dependency: schema first, then backend, then UI.

### Integration Tests

Integration tests are end-to-end verification specs agreed upon during PRD creation. After all stories pass, the QA agent builds automated tests matching these specs and verifies the feature works as a whole.

### Fields Reference

| Field | Type | Description |
|-------|------|-------------|
| `userStories[].id` | string | Story identifier (e.g., `US-001`) |
| `userStories[].passes` | bool | Set to `true` by the agent when complete |
| `userStories[].notes` | string | Agent notes (patterns learned, decisions made) |
| `integrationTests[].id` | string | Test identifier (e.g., `IT-001`) |
| `integrationTests[].passes` | bool | Set to `true` by QA agent when verified |
| `integrationTests[].failure` | string | Failure details if test didn't pass |
| `integrationTests[].notes` | string | QA agent notes |

## Prompt Customization

Ralph's agent behavior is driven by prompt templates compiled into the binary. You can customize them by ejecting:

```bash
ralph eject
```

This creates `.ralph/prompts/` with all templates:

| Template | Used by | Purpose |
|----------|---------|---------|
| `loop_iteration.md` | `ralph run` | Main prompt for implementing a single story |
| `qa_verification.md` | `ralph run` | QA agent prompt for integration test verification |
| `qa_fix.md` | `ralph run` | QA fix agent prompt for resolving test failures |
| `prd_new.md` | `ralph new` | Interactive PRD creation conversation |
| `chat_system.md` | `ralph chat` | System prompt for free-form chat sessions |
| `rebase_conflict.md` | `ralph rebase` | Conflict resolution prompt |

When `.ralph/prompts/` exists, Ralph loads templates from there instead of the built-in versions. You can override individual templates — any missing files fall back to the embedded defaults.

Templates use Go's `text/template` syntax with `{{ .FieldName }}` placeholders.

To re-eject (e.g., after upgrading Ralph), delete `.ralph/prompts/` and run `ralph eject` again.
